service: iger-backend

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    DYNAMODB_TABLE: ${self:custom.tableName}
    COGNITO_USER_POOL_ID: ${self:custom.cognitoUserPoolId}
    COGNITO_CLIENT_ID: ${env:COGNITO_CLIENT_ID, ''}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY, ''}
    PAYPAL_CLIENT_ID: ${env:PAYPAL_CLIENT_ID, ''}
    PAYPAL_SECRET: ${env:PAYPAL_SECRET, ''}
    PAYPAL_MODE: sandbox
    # CORS permitido: '*' permite todos los orÃ­genes (seguro para desarrollo)
    ALLOWED_ORIGIN: ${env:ALLOWED_ORIGIN, '*'}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.tableName}"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.tableName}/index/*"
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource:
            - "arn:aws:s3:::iger-assets/*"
        - Effect: Allow
          Action:
            - ssm:GetParameter
          Resource:
            - "arn:aws:ssm:${self:provider.region}:*:parameter/iger/*"
        - Effect: Allow
          Action:
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:AdminDeleteUser
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:AdminRespondToAuthChallenge
            - cognito-idp:ListUsers
            - cognito-idp:DescribeUserPool
            - cognito-idp:DescribeUserPoolClient
          Resource:
            - "arn:aws:cognito-idp:${self:provider.region}:*:userpool/*"

custom:
  tableName: IgerData
  cognitoUserPoolId: us-east-1_gY5JpRMyV 
  webpack:
    webpackConfig: ./webpack.config.js
    includeModules: true
package:
  individually: true
  excludeDevDependencies: true
functions:
  authLogin:
    handler: src/handlers/auth.login
    events:
      - http:
          path: auth/login
          method: post
          cors: true
  
  authRegister:
    handler: src/handlers/auth.register
    events:
      - http:
          path: auth/register
          method: post
          cors: true
  
  authRefresh:
    handler: src/handlers/auth.refresh
    events:
      - http:
          path: auth/refresh
          method: post
          cors: true
  
  authLogout:
    handler: src/handlers/auth.logout
    events:
      - http:
          path: auth/logout
          method: post
          cors: true
  
  authCreateUser:
    handler: src/handlers/auth.createUser
    events:
      - http:
          path: auth/admin/create-user
          method: post
          cors: true
  
  authChangePassword:
    handler: src/handlers/auth.changePasswordHandler
    events:
      - http:
          path: auth/change-password
          method: post
          cors: true
  
  authConfirmEmail:
    handler: src/handlers/auth.confirmEmailHandler
    events:
      - http:
          path: auth/confirm-email
          method: post
          cors: true
  
  authForgotPassword:
    handler: src/handlers/auth.forgotPasswordHandler
    events:
      - http:
          path: auth/forgot-password
          method: post
          cors: true
  
  authConfirmForgotPassword:
    handler: src/handlers/auth.confirmForgotPasswordHandler
    events:
      - http:
          path: auth/confirm-forgot-password
          method: post
          cors: true
  
  authMFASetup:
    handler: src/handlers/auth.setupMFA
    events:
      - http:
          path: auth/mfa/setup
          method: post
          cors: true
  
  authMFAVerify:
    handler: src/handlers/auth.verifyMFA
    events:
      - http:
          path: auth/mfa/verify
          method: post
          cors: true
  
  authMFAEnable:
    handler: src/handlers/auth.toggleMFA
    events:
      - http:
          path: auth/mfa/enable
          method: post
          cors: true
  
  authMFADisable:
    handler: src/handlers/auth.toggleMFA
    events:
      - http:
          path: auth/mfa/disable
          method: post
          cors: true
  
  authMFARespond:
    handler: src/handlers/auth.respondMFA
    events:
      - http:
          path: auth/mfa/respond
          method: post
          cors: true
  
  authRespondNewPassword:
    handler: src/handlers/auth.respondNewPassword
    events:
      - http:
          path: auth/respond-new-password
          method: post
          cors: true
  
  getStudents:
    handler: src/handlers/students.list
    events:
      - http:
          path: students
          method: get
          cors: true
  
  getStudent:
    handler: src/handlers/students.get
    events:
      - http:
          path: students/{studentId}
          method: get
          cors: true
  
  createStudent:
    handler: src/handlers/students.create
    events:
      - http:
          path: students
          method: post
          cors: true
  
  updateStudent:
    handler: src/handlers/students.update
    events:
      - http:
          path: students/{studentId}
          method: put
          cors: true
  
  deleteStudent:
    handler: src/handlers/students.remove
    events:
      - http:
          path: students/{studentId}
          method: delete
          cors: true
  
  getTasks:
    handler: src/handlers/tasks.list
    events:
      - http:
          path: tasks
          method: get
          cors: true
  
  getTask:
    handler: src/handlers/tasks.get
    events:
      - http:
          path: classes/{classId}/tasks/{taskId}
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
              - X-Amz-Security-Token
            allowCredentials: false
            methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
  
  createTask:
    handler: src/handlers/tasks.create
    events:
      - http:
          path: tasks
          method: post
          cors: true
  
  updateTask:
    handler: src/handlers/tasks.update
    events:
      - http:
          path: classes/{classId}/tasks/{taskId}
          method: put
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
              - X-Amz-Security-Token
            allowCredentials: false
            methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
  
  deleteTask:
    handler: src/handlers/tasks.remove
    events:
      - http:
          path: classes/{classId}/tasks/{taskId}
          method: delete
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
              - X-Amz-Security-Token
            allowCredentials: false
            methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
  
  createTaskSubmission:
    handler: src/handlers/tasks.createSubmission
    events:
      - http:
          path: tasks/{taskId}/submissions
          method: post
          cors: true
  
  getTaskSubmissions:
    handler: src/handlers/tasks.getSubmissions
    events:
      - http:
          path: tasks/{taskId}/submissions
          method: get
          cors: true
  
  getEvents:
    handler: src/handlers/events.list
    events:
      - http:
          path: events
          method: get
          cors: true
  
  getEvent:
    handler: src/handlers/events.get
    events:
      - http:
          path: events/{eventId}
          method: get
          cors: true
  
  createEvent:
    handler: src/handlers/events.create
    events:
      - http:
          path: events
          method: post
          cors: true
  
  updateEvent:
    handler: src/handlers/events.update
    events:
      - http:
          path: events/{eventId}
          method: put
          cors: true
  
  deleteEvent:
    handler: src/handlers/events.remove
    events:
      - http:
          path: events/{eventId}
          method: delete
          cors: true
  
  listInvoices:
    handler: src/handlers/payments.listInvoices
    events:
      - http:
          path: payments/invoices
          method: get
          cors: true
  
  createInvoice:
    handler: src/handlers/payments.createInvoice
    events:
      - http:
          path: payments/invoices
          method: post
          cors: true
  
  createPayPalOrder:
    handler: src/handlers/payments.createPayPalOrder
    events:
      - http:
          path: payments/create-order
          method: post
          cors: true
  
  paypalWebhook:
    handler: src/handlers/payments.handlePayPalWebhook
    events:
      - http:
          path: payments/webhook
          method: post
          cors: true
  
  getInvoice:
    handler: src/handlers/payments.getInvoice
    events:
      - http:
          path: payments/invoices/{invoiceId}
          method: get
          cors: true
  
  registerAttendance:
    handler: src/handlers/attendance.registerAttendance
    events:
      - http:
          path: attendance
          method: post
          cors: true
  
  getAttendance:
    handler: src/handlers/attendance.getAttendance
    events:
      - http:
          path: attendance
          method: get
          cors: true
  
  getAttendanceReports:
    handler: src/handlers/attendance.getAttendanceReports
    events:
      - http:
          path: attendance/reports
          method: get
          cors: true
  
  syncPull:
    handler: src/handlers/sync.pull
    events:
      - http:
          path: sync/pull
          method: post
          cors: true
  
  syncPush:
    handler: src/handlers/sync.push
    events:
      - http:
          path: sync/push
          method: post
          cors: true
  
  aiSummarize:
    handler: src/handlers/ai.summarize
    events:
      - http:
          path: ai/summarize
          method: post
          cors: true
  
  aiTutor:
    handler: src/handlers/ai.tutor
    events:
      - http:
          path: ai/tutor
          method: post
          cors: true
  
  aiGenerateContent:
    handler: src/handlers/ai.generateContent
    events:
      - http:
          path: ai/generate-content
          method: post
          cors: true

plugins:
  - serverless-dotenv-plugin
  # - serverless-plugin-typescript
  # - serverless-offline

resources:
  Resources:
    IgerTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableName}
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        TimeToLiveSpecification:
          AttributeName: TTL
          Enabled: true
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    AlertsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-${self:provider.stage}-alerts
        DisplayName: Alertas Iger ${self:provider.stage}

    AlertsTopicPolicy:
      Type: AWS::SNS::TopicPolicy
      Properties:
        Topics:
          - Ref: AlertsTopic
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Sid: AllowCloudWatchPublish
              Effect: Allow
              Principal:
                Service: cloudwatch.amazonaws.com
              Action: SNS:Publish
              Resource:
                Fn::GetAtt:
                  - AlertsTopic
                  - TopicArn

    Api5xxAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-apigw-5xx
        AlarmDescription: API Gateway 5XX >= 1 en 5 minutos
        Namespace: AWS/ApiGateway
        MetricName: 5XXError
        Dimensions:
          - Name: ApiName
            Value: ${self:service}-${self:provider.stage}
          - Name: Stage
            Value: ${self:provider.stage}
        Period: 300
        EvaluationPeriods: 1
        Statistic: Sum
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - Ref: AlertsTopic

    ApiLatencyP95Alarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-apigw-latency-p95
        AlarmDescription: API Gateway Latency p95 > 1s
        Namespace: AWS/ApiGateway
        MetricName: Latency
        Dimensions:
          - Name: ApiName
            Value: ${self:service}-${self:provider.stage}
          - Name: Stage
            Value: ${self:provider.stage}
        Period: 300
        EvaluationPeriods: 1
        ExtendedStatistic: p95
        Threshold: 1000
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - Ref: AlertsTopic

    LambdaUpdateTaskErrorsAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-lambda-updateTask-errors
        AlarmDescription: Errores en Lambda updateTask
        Namespace: AWS/Lambda
        MetricName: Errors
        Dimensions:
          - Name: FunctionName
            Value: ${self:service}-${self:provider.stage}-updateTask
        Period: 300
        EvaluationPeriods: 1
        Statistic: Sum
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - Ref: AlertsTopic

    LambdaCreateEventErrorsAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-lambda-createEvent-errors
        AlarmDescription: Errores en Lambda createEvent
        Namespace: AWS/Lambda
        MetricName: Errors
        Dimensions:
          - Name: FunctionName
            Value: ${self:service}-${self:provider.stage}-createEvent
        Period: 300
        EvaluationPeriods: 1
        Statistic: Sum
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - Ref: AlertsTopic

    ApiGatewayUsagePlan:
      Type: AWS::ApiGateway::UsagePlan
      Properties:
        UsagePlanName: ${self:service}-${self:provider.stage}-usage-plan
        Throttle:
          BurstLimit: 200
          RateLimit: 100.0
        Quota:
          Limit: 10000
          Period: DAY
        ApiStages:
          - ApiId:
              Ref: ApiGatewayRestApi
            Stage: ${self:provider.stage}

